image: dylanops/php:7.4

variables:
  COMPOSER_USER: cbb842dfe5c6b13a5e82ee3736e43f22
  COMPOSER_PASSWD: a3cd6560594ddfb6302579621b75ff88
  SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
  GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task

cache:
  paths:
    - vendor/

before_script:
  - composer config http-basic.repo.magento.com $COMPOSER_USER $COMPOSER_PASSWD
  - composer install

stages:
  - build
  - check-quality
  - test
  - deploy

executing-build:
  stage: build
  only:
    - main
    - uat
    - dev
  cache:
    key: caches
    paths:
      - generated
    policy: push
  script:
    - composer config http-basic.repo.magento.com $COMPOSER_USER $COMPOSER_PASSWD
    - composer install
    - php bin/magento module:enable --all
    - php bin/magento setup:di:compile

executing-check-quality:
  stage: check-quality
  only:
    - main
    - uat
    - dev
  cache:
    key: caches
    paths:
      - generated
    policy: pull
  script:
    - vendor/bin/phpcs -n --standard=dev/tests/static/framework/Magento app/code
    - vendor/bin/phpmd app/code/ text .phpmd.xml
    - vendor/bin/phpstan analyse --level=8 --configuration=.phpstan.neon app/code

excuting-test:
  stage: test
  only:
    - main
    - uat
    - dev
  cache:
    key: caches
    paths:
      - generated
    policy: pull
  script:
    - php -d xdebug.mode=coverage vendor/phpunit/phpunit/phpunit -c .phpunit.xml app/code/ --coverage-html coverage
  artifacts:
    when: always
    paths:
      - ./coverage
    expire_in: 1 week

sonarcloud-check:
  stage: sona
  image:
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script:
    - sonar-scanner
  only:
    - merge_requests
    - main
    - dev

excuting-deploy:
  stage: deploy
  only:
    - tags
  script:
    - echo "deploy completed"
